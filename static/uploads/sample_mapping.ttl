@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cidoc: <http://erlangen-crm.org/current/> .

@prefix b2022: <https://ont.beyond2022.ie/ontology#> .

<#Organisation>
	a rr:TriplesMap ;

	rr:logicalTable [ rr:sqlQuery """
	SELECT 
		D.ID,
		D.NAME,
		D.COUNTRY,
		D.COMMENT,
		X.ORGANISATIONTYPE
	FROM
		DATA D
		LEFT OUTER JOIN (
			WITH RECURSIVE ORGANISATIONTYPESPLITTED(ID, ORGANISATIONTYPE, REST) AS (
				SELECT ID, NULL, ORGANISATIONTYPE || ';'
				FROM (SELECT ID, ORGANISATIONTYPE FROM DATA) WHERE ORGANISATIONTYPE IS NOT NULL
				UNION ALL
				SELECT ID, TRIM(SUBSTR(REST, 0, INSTR(REST, ';') - 1)), SUBSTR(REST, INSTR(REST, ';') + 1) FROM ORGANISATIONTYPESPLITTED WHERE REST <> ''
			) SELECT ID, ORGANISATIONTYPE FROM ORGANISATIONTYPESPLITTED WHERE ORGANISATIONTYPE IS NOT NULL
		) X ON D.ID = X.ID

	""" ] ;

	rr:subjectMap [
		rr:template "https://kb.beyond2022.ie/organisation/{COUNTRY}/{NAME}" ;
		rr:class cidoc:E74_Group ;
	] ;

	rr:predicateObjectMap [
		rr:predicate cidoc:P2_has_type ;
		rr:object b2022:Organisation ; # Note that it is implied that this class is an instance of cidoc:E55_Type
	] ;

	rr:predicateObjectMap [
		rr:predicate cidoc:P1_is_identified_by ;
		rr:objectMap [
			rr:parentTriplesMap <#Appellation> ;
			rr:joinCondition [ rr:child "ID" ; rr:parent "ID" ; ] ;
		] ;
	] ;

	rr:predicateObjectMap [
		rr:predicate cidoc:P3_has_note ;
		rr:objectMap [
			rr:column "COMMENT" ;
			rr:datatype xsd:string ;
		] ;
	] ;

	rr:predicateObjectMap [
		rr:predicate cidoc:P2_has_types ;
		rr:objectMap [ rr:template "https://ont.beyond2022.ie/ontology#{ORGANISATIONTYPE}" ] ;
	] ;
.
