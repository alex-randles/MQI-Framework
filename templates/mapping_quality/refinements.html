<!DOCTYPE html>
{% extends "mapping_quality/assessment_result.html" %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
{% block message %}
<!--<div class="alert alert-success my-3" role="alert">-->
<!--    <h4 class="alert-heading">Refinements created</h4>-->
<!--    <p>Refinements have been generated in the <b>table below this table</b></p>-->
<!--</div>-->
{% endblock %}
{% block refinements %}

<script>
    function hideQualityInformation() {
         document.getElementById("refinement-selection").style.display = "none";
         document.getElementById("show-info").style.display = "block";
         document.getElementById("hide-info").style.display = "none";
    }
    function showQualityInformation() {
         document.getElementById("refinement-selection").style.display = "block";
         document.getElementById("show-info").style.display = "none";
         document.getElementById("hide-info").style.display = "block";
    }
    window.onload = hideQualityInformation;

// validate atleast one refinement selected for execution
function validateRefinementExecution() {
    var checkboxs = document.querySelectorAll("input[type='checkbox']");
    var box_checked = false;
    for(var i = 0,l = checkboxs.length;i < l;i++)
    {
        if(checkboxs[i].checked)
        {
            box_checked=true;
            break;
        }
    }
    if(box_checked) {
           return true;
    }
    else {
           document.getElementById('no-refinements-executed').style.display = "block";
           return false;
    }
}
</script>

{% if show_refinement_buttons != true %}
<div class="alert alert-primary my-3 text-center" role="alert">
    <h4 class="alert-heading">Mapping Refinement Information</h4>
    <p>The table below shows the mapping quality information generated by the framework. <strong>Check the 'Execute' box for refinements you want to be executed or 'Execute All Refinements'.</strong></p>
</div>

<form action="/refinement" class="mb-2" method="POST" id="myForm" name="myForm" onsubmit="return validateRefinementExecution()" >
    <table class="table table-striped table-hover"  id="refinements_table">
        <thead class="thead-dark">
        <tr>
            <th scope="col">
                Violation ID
            </th>
            <th scope="col">
                Refinement
                <i class="bi bi-info-circle"  title="The refinement you have selected for this violation"></i>
            </th>
            <th scope="col">
                Violation Result Message
            </th>
            <th scope="col">
                Violation Value
            </th>
            <th scope="col">
                Triple Map
            </th>
            <th scope="col">
                Refinement Values
                <i class="bi bi-info-circle"  title="The values which will be used for executing these refinements"></i>
            </th>
            <th scope="col">
                <button type="button" class="btn btn-sm btn-secondary" id="selectAll" onClick='selectAllRefinements()'>Execute All Refinements</button>
            </th>
            <th scope="col">
                Display violation
                <i class="bi bi-info-circle"  title="Select the refinements you want to be executed"></i>
            </th>
        </tr>
        </thead>
        <tbody>
        {% set input_form_ids = [] %}
        {%for violation_ID, refinement_values in refinements.items()%}
        {% set triple_map = refinement_values.get("triple_map") %}
        {% set refinement_name = refinement_values.get("name") %}
        {% set user_input = refinement_values.get("user_input") %}
        {% set requires_prefixes = refinement_values.get("requires_prefixes") %}
        {% set restricted_values = refinement_values.get("restricted_values") %}
        {% set refinement_properties = refinement_values.get("values") %}
        {% set optional_values = refinement_values.get("optional_values") %}
        {% set violation_value = find_prefix(validation_result[violation_ID|int]["value"]) %}
        {% set violation_location = assessment_report %}
        {% set violation_location = find_violation_location(assessment_report[violation_ID| int]["location"]) %}
        <tr>
            <td>
                {{violation_ID}}
            </td>
            <td>
                {{split_camel_case(refinement_name)}}
                {% set refinement_description = refinement_descriptions.get(refinement_name) %}
                <span class="tt" data-bs-placement="top" title="{{refinement_description}}">
                    <i class="bi bi-info-circle" ></i>
                </span>
            </td>
            <td>
                {{ assessment_report.get(violation_ID).get("result_message") }}
            </td>
            <td>
                {{violation_value}}
            </td>
            <td>
                {{find_triple_map(violation_ID)}}
            </td>
            {% set violation_ID = violation_ID|string %}
            {% if user_input == false %}
            <td  style="width:25%; font-weight:bold;">{{find_prefix(refinement_properties)}}</td>

            {% elif requires_prefixes is none and restricted_values is none %}

            <td  style="width:25%">
                {% for value in refinement_properties.get("requires_prefixes") %}
                {% set form_value = violation_ID + '-' + value %}
                {% set prefix_value = violation_ID + '-' + 'PREFIX' + '-' + value %}

                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value) }} {
                    {% endif %}
                </div>

                <label for={{form_value}}>
                    Property: <strong>{{find_prefix(value)}}</strong>
                </label>
                <input class="form-control my-2 w-100" list={{prefix_value}} name={{prefix_value}} id="exampleDataList" placeholder="Search for a prefix" required>
                <datalist id={{prefix_value}}>
                    <option value="" disabled selected>Choose a prefix </option>
                    {% for prefix in prefix_values.keys() %}
                    <option value={{prefix}}>{{prefix}}</option>
                    {% endfor  %}
                </datalist>

                <input style="width:95%" placeholder="Enter the remainig IRI for the prefix" type="text" id={{form_value}} name={{form_value}} required>
                <span class="tt" data-bs-placement="top" title="Do not include brackets (<>) for IRIs">
              <i class="bi bi-info-circle" ></i>
          </span>
                {% endfor %}

                {% for value in refinement_properties.get("no_prefixes") %}
                {% set form_value_2 = violation_ID + '-' + value %}
                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value_2) }}
                    {% endif %}
                </div>
                <div class="col-6">
                    <label for={{form_value_2}}>
                        Property: <strong>{{find_prefix(value)}}</strong>
                    </label>
                </div>
                <div>
                    <input type="text" class="w-100" id={{form_value_2}} name={{form_value_2}}>
                </div>


                {% endfor %}

            </td>


            {% elif user_input == true and requires_prefixes == true and restricted_values is none %}

            <td  style="width:25%">
                {% for value in refinement_properties %}
                {% set form_value = violation_ID + '-' + value %}
                {% set prefix_value = violation_ID + '-' + 'PREFIX' + '-' + value %}

                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value) }} {
                    {% endif %}
                </div>
                <label for={{form_value}}>
                    Property: <strong>{{find_prefix(value)}}</strong>
                </label>
                <select  style="width:100%" name={{prefix_value}} id={{prefix_value}} required>
                    <option value="" disabled selected>Choose a prefix </option>
                    {% for prefix in prefix_values.keys() %}
                    <option value={{prefix}}>{{prefix}}</option>
                    {% endfor  %}
                </select>
                <input style="width:95%" placeholder="Enter the remainig IRI for the prefix" type="text" id={{form_value}} name={{form_value}} required>
                <span class="tt" data-bs-placement="top" title="Do not include brackets (<>) for IRIs">
              <i class="bi bi-info-circle" ></i>
          </span>
                {% endfor %}
            </td>
            {% elif restricted_values is none %}
            <td style="width:25%">
                {% for value in refinement_properties %}
                {% set form_value_2 = violation_ID + '-' + value %}
                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value_2) }}
                    {% endif %}
                </div>
                <div class="col-6">
                    <label for={{form_value_2}}>
                        Property: <strong>{{find_prefix(value)}}</strong>
                    </label>
                </div>
                <div>
                    <input type="text" class="w-75" id={{form_value_2}} name={{form_value_2}}>
                </div>
                {% endfor %}
            </td>

            {% else %}

            <td style="width:25%">
                {% for value in refinement_properties %}
                {% set form_value_3 = violation_ID + '-' + value %}
                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value_3) }} {
                    {% endif %}
                </div>
                <b>Property: {{find_prefix(value)}}</b>
                <label for={{form_value_3}}></label>
                <select data-live-search="true" class="form-select" name={{form_value_3}} id={{form_value_3}} style="max-width:100%" required>
                    {% for (placeholder, values) in restricted_values.items() %}
                    <option value="" disabled selected>{{placeholder}}</option>
                    {% for value in values %}
                    {% if value is iterable and (value is not string and value is not mapping) %}
                    <option class="font-weight" value={{value[0]}}>{{find_prefix(value[0])}}</option>
                    <option disabled>{{ value[1] }}</option>

                    {% else %}
                    <option value={{value}}>{{find_prefix(value)}}</option>
                    {% endif %}
                    {% endfor %}
                    {% endfor  %}
                </select>
                {% endfor %}
            </td>
            {% endif %}
            <td class="table-data">
                {% set class_name = "btn btn-secondary" + violation_ID %}
                <input type="checkbox" id={{violation_ID}} class={{class_name}} name={{violation_ID}} value="Execute">
                <label for={{violation_ID}}>Execute</label>
            </td>
            <td class="table-data">
                {% set display_button_id = violation_ID|string + 'refinements_div' %}
                <div class="mb-1">
                    {% set button_text_div = 'button-' + display_button_id %}
                    <button id="{{button_text_div}}" class="btn btn-secondary my-3" type="button" onClick="showDiv('{{display_button_id}}');">Display Violation</button>
                </div>
                <div id="{{violation_ID|string + 'refinements_div'}}" style="display:none">
                    {% set violation_ID = violation_ID|int %}
                    {% set current_result = validation_result.get(violation_ID) %}
                    {% set violation_display = display_violation(current_result.get("location"), current_result.get("triple_map"), current_result.get("value")) %}
                    {% if violation_display %}
                    {% for triple in violation_display %}
                    {% if violation_value %}
                    {% if parse_violation_value(violation_value) in triple %}
                    <pre style="color:red;"><span>{{triple}}</span></pre>
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    No specific triples associated with violation.
                    {% endif %}

                </div>
            </td>
        </tr>
        {%endfor%}
        </tbody>
    </table>
    <div class="row my-3 justify-content-center">
        <div class="col-6 text-center">
            <div class="alert alert-danger my-3 text-center" id="no-refinements-executed" style="display:none;" role="alert">
                <strong>No refinements are selected to be executed. Please check atleast one checkbox.</strong>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col text-center">
            <input type="Submit" class="btn btn-secondary" id="button-style" value="Execute Refinements">
        </div>
    </div>
</form>
{% endif %}
<script>
 $(document).ready(function () {
  $('body').on('click', '#selectAll', function () {
    if ($(this).hasClass('allChecked')) {
        $('input[type="checkbox"]', '#refinements_table').prop('checked', false);
    } else {
        $('input[type="checkbox"]', '#refinements_table').prop('checked', true);
    }
    $(this).toggleClass('allChecked');
  })
});
</script>
<script>
function clickList() {
    document.getElementById('exampleDataList').click();
    console.log("djdjjd");
}
</script>
<script>
</script>
{% endblock %}
{% block refinement_buttons %}
{% endblock %}
</body>
</html>