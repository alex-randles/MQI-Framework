<!DOCTYPE html>
{% extends "mapping_quality/assessment_result.html" %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
{% block message %}
<!--<div class="alert alert-success my-3" role="alert">-->
<!--    <h4 class="alert-heading">Refinements created</h4>-->
<!--    <p>Refinements have been generated in the <b>table below this table</b></p>-->
<!--</div>-->
{% endblock %}
{% block refinements %}

<script>
    function hideQualityInformation() {
         document.getElementById("test").style.display = "none";
         document.getElementById("show-info").style.display = "block";
         document.getElementById("hide-info").style.display = "none";
    }
    function showQualityInformation() {
         document.getElementById("test").style.display = "block";
         document.getElementById("show-info").style.display = "none";
         document.getElementById("hide-info").style.display = "block";
    }
    window.onload = hideQualityInformation;
</script>
<div class="alert alert-primary my-3" role="alert">
    <h4 class="alert-heading">Mapping Refinement Information</h4>
    <p>The table below shows the mapping quality information generated by the framework</p>
</div>

<form action="/refinement" method="POST" name="myForm" onsubmit="return validateForm()" style="margin-bottom:2%;" >

    <table class="table table-striped table-hover"  id="refinements_table">
        <thead class="thead-dark">
        <tr>
            <th scope="col">
                Violation ID

            </th>
            <th scope="col">
                Refinement
                <i class="bi bi-info-circle"  title="The refinement you have selected for this violation"></i>

            </th>
            <th scope="col">
                Violation Value

            </th>

            <th scope="col">
                Triple Map

            </th>

            <th scope="col">
                Violation location

            </th>
            <th scope="col">
                Refinement Values
                <i class="bi bi-info-circle"  title="The values which will be used for executing these refinements"></i>

            </th>


            <th scope="col">
<!--                Select Refinements-->
<!--                <i class="bi bi-info-circle"  title="Select the refinements you want to be executed"></i>-->

                <button type="button" title="Testing" id="selectAll" class="main"> <span class="sub"></span> Execute All Refinements</button>


            </th>


            <th scope="col">
                Display violation
                <i class="bi bi-info-circle"  title="Select the refinements you want to be executed"></i>

            </th>

        </tr>
        </thead>
        <tbody>

        {% set input_form_ids = [] %}
        {%for violation_ID, refinement_values in refinements.items()%}
        {% set triple_map = refinement_values["triple_map"] %}
        {% set refinement_name = refinement_values["name"] %}
        {% set user_input = refinement_values["user_input"] %}
        {% set requires_prefixes = refinement_values["requires_prefixes"] %}
        {% set restricted_values = refinement_values["restricted_values"] %}
        {% set refinement_properties = refinement_values["values"] %}
        {% set optional_values = refinement_values["optional_values"] %}
        {% set violation_value = find_prefix(validation_result[violation_ID|int]["value"]) %}
        {% set violation_location = assessment_report %}
        {% set violation_location = find_violation_location(assessment_report[violation_ID| int]["location"]) %}

        <tr>

            <td>
                {{violation_ID}}
            </td>

            <td>
                {{split_camel_case(refinement_name)}}

                {% set refinement_description = refinement_descriptions.get(refinement_name) %}
                <a class="tags"
                   gloss="{{refinement_description}}">
                    <i class="fa fa-info-circle info-button">
                    </i></a>

            </td>

            <td>
                {{violation_value}}
            </td>

            <td>
                {{find_triple_map(violation_ID)}}
            </td>

            <td>
                {{violation_location}}
            </td>
            {% set violation_ID = violation_ID|string %}
            {% if user_input == false %}
            <td  style="width:100%; font-weight:bold;">{{find_prefix(refinement_properties)}}</td>

            {% elif user_input == true and requires_prefixes == true and restricted_values is none %}

            <td  style="width:100%">

                {% for value in refinement_properties %}
                {% set form_value = violation_ID + '-' + value %}
                {% set prefix_value = violation_ID + '-' + 'PREFIX' + '-' + value %}

                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value) }} {
                    {% endif %}
                </div>

                <label for={{form_value}}><b>Property: {{find_prefix(value)}} </b>
                    <!--                                 <a class="tags"-->
                    <!--                                    gloss="The refinement you have selected for this violation.">-->
                    <!--                                     <i class="fa fa-info-circle info-button">-->
                    <!--                                     </i></a>-->
                </label>
                <select  style="width:100%" name={{prefix_value}} id={{prefix_value}} required>
                    <option value="" disabled selected>Choose a prefix </option>
                    {% for prefix in prefix_values.keys() %}
                    <option value={{prefix}}>{{prefix}}</option>
                    {% endfor  %}
                </select>

                <input style="width:100%" placeholder="Enter the remainig IRI for the prefix" type="text" id={{form_value}} name={{form_value}} required>

                {% endfor %}
            </td>

            {% elif restricted_values is none %}

            <td style="width:100%">

                {% for value in refinement_properties %}
                {% set form_value_2 = violation_ID + '-' + value %}


                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value_2) }}
                    {% endif %}
                </div>

                <label for={{form_value_2}}><b>Property: {{find_prefix(value)}}</b></label>

                <input type="text" id={{form_value_2}} name={{form_value_2}} required>


                {% endfor %}
            </td>

            {% else %}

            <td style="width:160%">
                {% for value in refinement_properties %}
                {% set form_value_3 = violation_ID + '-' + value %}


                <div style="display:none">
                    {% if optional_values is not true %}
                    {{ input_form_ids.append(form_value_3) }} {
                    {% endif %}
                </div>

                <b>Property: {{find_prefix(value)}}</b>
                <label for={{form_value_3}}></label>
                <select data-live-search="true" class="form-select" name={{form_value_3}} id={{form_value_3}} required>
                    {% for (placeholder, values) in restricted_values.items() %}
                    <option value="" disabled selected>{{placeholder}}</option>
                    {% for value in values %}
                    {% if value is iterable and (value is not string and value is not mapping) %}
                    <option value={{value[0]}}>{{find_prefix(value[0])}}</option>
                    <option disabled>{{ value[1] }} </option>

                    {% else %}
                    <option value={{value}}>{{find_prefix(value)}}</option>
                    {% endif %}
                    {% endfor %}
                    {% endfor  %}
                </select>
                {% endfor %}
            </td>

            {% endif %}


            <td class="table-data">
                {% set class_name = "btn btn-secondary" + violation_ID %}
                <input type="checkbox" id={{violation_ID}} class={{class_name}} name={{violation_ID}} value="Execute">
                <label for={{violation_ID}}>Execute</label>


            </td>
            <td class="table-data">
                <div> <button class="btn btn-secondary" type="button" onclick="showDiv('{{violation_ID + 'refinements_div'}}')"> <span class="sub"></span>Display Violation</button></div>
                <div id="{{violation_ID|string + 'refinements_div'}}" style="display:none">
                    {% set violation_ID = violation_ID|int %}
                    {% set violation_display = display_violation(validation_result[violation_ID]["location"], validation_result[violation_ID]["triple_map"], validation_result[violation_ID]["value"]) %}
                    {% if violation_display %}
                    {% for triple in violation_display %}
                    {% if violation_value %}
                    {% if parse_violation_value(violation_value) in triple %}
                    <pre style="color:red;"><span>{{triple}}</span></pre>
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <pre>Violation has no triples related.</pre>
                    {% endif %}

                </div>
            </td>
        </tr>
        {%endfor%}




        </tbody>
    </table>


    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col text-center">
                <input type="Submit" class="btn btn-secondary" id="button-style" value="Execute Refinements">

            </div>
        </div>
    </div>
</form>



<!--<div class="container-fluid p-3">-->
<!--  <div class="row">-->
<!--    <div class="col-md-6">-->
<!--<button type="button" class="btn btn-secondary float-end">Export Refined Mapping</button>-->
<!--    </div>-->
<!--    <div class="col-md-6">-->



<!--      &lt;!&ndash; Button trigger modal &ndash;&gt;-->
<!--      <button type="button" class="btn btn-secondary" data-bs-toggle="modal"-->

<!--              data-bs-target="#exampleModal">-->
<!--        Export Refined Mapping-->
<!--      </button>-->

<!--      &lt;!&ndash; Modal &ndash;&gt;-->
<!--      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">-->
<!--        <div class="modal-dialog">-->
<!--          <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--              <h5 class="modal-title" id="exampleModalLabel">Mapping Information</h5>-->
<!--              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--              Only RDF comments (rdfs:comment) will be in the refined mapping and not hash comments (#).-->
<!--                <br>-->
<!--                <br>-->
<!--                Also the ordering of the triples could change as RDF graphs have no order.-->







<script>
         $(document).ready(function () {
          $('body').on('click', '#selectAll', function () {
            if ($(this).hasClass('allChecked')) {
                $('input[type="checkbox"]', '#refinements_table').prop('checked', false);
            } else {
                $('input[type="checkbox"]', '#refinements_table').prop('checked', true);
            }
            $(this).toggleClass('allChecked');
          })
        });


</script>



<!--    </div>-->
<!--  </div>-->
<!--</div>-->


{% if show_refinement_buttons == true %}


<!--<div class="container">-->
<!--    <div class="row">-->
<!--        <div class="col text-center">-->
<!--            <a href="/return-refined-mapping/" target="blank"><button onclick="myFunction()" class="button-style btn btn-secondary">-->
<!--                Export Refined Mapping (TTL)</button></a>-->
<!--            <a  href="/return-refinement-report/" target="blank"><button class="button-style btn btn-secondary">-->
<!--                Export Validation Report (TTL)</button></a>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->


{% endif %}
{% endblock %}


{% block refinement_buttons %}
{% endblock %}
</body>
</html>