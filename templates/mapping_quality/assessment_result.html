<!DOCTYPE html>
{% extends "mapping_quality/base.html" %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Assessment{% endblock %}</title>
    <script type="text/javascript"  src="{{ url_for('static', filename='js_scripts.js') }}"> </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
</head>
{% block content %}

{% if show_refinement_buttons == true %}
<div class="alert alert-success text-center" role="alert">
    <h4 class="alert-heading">Refined Mapping Generated</h4>
    <p>Refined Mapping and Validation report can be downloaded <strong>below.</strong></p>
</div>

<div class="d-flex justify-content-center">
    <a href="{{ url_for('static', filename='refined_mapping.ttl')}}"><button onclick="downloadWarning()" class="btn-secondary btn button-style mx-3 p-2">
        Export Refined Mapping (TTL)</button></a>
    <a href="{{ url_for('static', filename='validation_report.ttl')}}"><button class="btn-secondary btn button-style mx-3 p-2">
        Export Validation Report (TTL)</button></a>
</div>
{% else %}

{% block message %}
{% endblock %}

{% endif %}
<body>
<div id="show-info" style="display:none">
    <button type="button" class="btn btn-primary mx-3" onclick="showQualityInformation()">Show Assessment Information</button>
</div>

<div id="hide-info" style="display:none">
    <button type="button" class="btn btn-primary mx-3" onclick="hideQualityInformation()">Hide Assessment Information</button>
</div>

{% set no_refinements_available = namespace(value=true) %}
<form id="refinement-selection" action="{{ url_for('get_refinements') }}" onsubmit="return validateRefinementSelection()">
    <div class="p-2">
        <h4 class="text-muted">Mapping Assessment Information</h4>
        <p class="font-weight-light">The table below shows the mapping quality information generated by the framework.<strong> Select refinements then press 'Create Refinements'</strong></p>
    </div>

    <table class="table table-striped table-hover" id="assessment-table">
        <thead class="thead-dark">
        <tr>
            <th scope="col">
                Violation ID
                <span class="tt" data-bs-placement="top" title="Unique ID">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Metric ID
                <span class="tt" data-bs-placement="top" title="Unique ID">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Result Message
                <span class="tt" data-bs-placement="top" title="Value which triggered the violation">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">Violation value
                <span class="tt" data-bs-placement="top" title="Refinements available for this violation">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Triple Map
                <span class="tt" data-bs-placement="top" title="Triple map which contains the violation">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Violation Location
                <span class="tt" data-bs-placement="top" title="Location within the triple map">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Select Refinements
                <span class="tt" data-bs-placement="top" title="Refinements available for this violation">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
            <th scope="col">
                Display violation
                <span class="tt" data-bs-placement="top" title="Violation value in red">
              <i class="bi bi-info-circle" ></i>
          </span>
            </th>
        </tr>

        </thead>
        <tbody>

        {% for violation_ID in assessment_report.keys() %}
        {% set current_violation = assessment_report.get(violation_ID) %}
        {% set metric_ID = current_violation.get("metric_identifier") %}
        {% set result_message = current_violation.get("result_message") %}
        {% set violation_value = find_prefix(current_violation.get("value")) %}
        {% set triple_map = get_triple_map_ID(current_violation.get("triple_map")) %}
        {% set violation_location = find_violation_location(current_violation.get("location")) %}

        <tr>
            <td  scope="col">{{violation_ID}}</td>
            {% set metric_id_link = 'https://w3id.org/MQIO-metrics/#' + metric_ID %}
            <td scope="col"><a href={{metric_id_link}} target="_blank" class="link-secondary">{{metric_ID}}</a></td>
            <td scope="col">{{result_message}}
                {% set metric_description = metric_descriptions.get(metric_ID) %}
                <span class="tt" data-bs-placement="top" title="{{metric_description}}">
                    <i class="bi bi-info-circle" ></i>
                </span>
            </td>
            <td scope="col">{{violation_value}}</td>
            <td scope="col">{{triple_map}}</td>
            <td scope="col">{{violation_location}}</td>
            <td scope="col" style="width:15%">
                {% set current_refinements = suggested_refinements[violation_ID] %}
                {% if current_refinements|length > 0 %}
                <select class="form-select form-select-sm" id={{violation_ID}} name={{violation_ID}}>
                    <option value="Manual">Manual</option>
                    <option value="description" disabled>Refine using text editor</option>
                    {% for refinement in current_refinements %}
                    <option value={{refinement}}>{{split_camel_case(refinement)}}</option>
                    <option value="description" disabled>{{refinement_descriptions[refinement]}}</option>
                    {% endfor %}
                </select>
                {% set no_refinements_available.value = False %}
                {% else %}
                <span style="color:red;">
                    Vocabulary related metrics must be refined by the maintainers of the vocabulary.
                </span>
                {% endif %}
            </td>

            <td scope="col">

                {% set display_button_id = violation_ID|string + 'assessment_result_div' %}
                <div class="mb-1">
                    {% set button_text_div = 'button-' + display_button_id %}
                    <button id="{{button_text_div}}" class="btn btn-secondary my-3" type="button" onClick="showDiv('{{display_button_id}}');">Display Violation</button>
                </div>
                <div id="{{display_button_id}}" style="display:none;">
                    {% set current_result = validation_result.get(violation_ID) %}
                    {% set violation_display = display_violation(current_result.get("location"), current_result.get("triple_map"), current_result.get("value")) %}
                    {% if violation_display %}
                    {% for triple in violation_display %}
                    {% if violation_value %}
                    {% if parse_violation_value(violation_value) in triple %}
                    <pre  style="color:red;"><span>{{triple}}</span></pre>
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% else %}
                    <pre>{{triple}}</pre>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    No specific triples associated with violation.
                    {% endif %}

                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% if not no_refinements_available.value %}
    <div class="container">
        <div class="row my-3">
            <div class="col text-center">
                <div class="alert alert-danger my-3 text-center" id="manual-refinements-warning" style="display:none;" role="alert">
                    <strong>All refinements selected are 'Manual'. You will need to complete refinements using a text editor and re-upload the mapping.</strong>
                </div>
                <button type="submit" class="btn btn-primary mt-3 mb-2">Create Refinements</button>
                <span class="tt" data-bs-placement="top" title="This button will generate the refinements you have selected. If you change refinements after pressing the button, press this button again.">
                    <i class="bi bi-info-circle" ></i> </span>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col-sm-6 d-flex justify-content-end">
            <a href="{{ url_for('download_quality_report') }}" class="btn btn-secondary px-2"  role="button">Export Quality Report (TTL)</a>
        </div>
        <div class="col-sm-6">
            <a class="btn btn-secondary float-right"  role="button"  id="btPrint" onClick="createPDF()">Download Table (PDF)</a>
        </div>
    </div>
</form>




{% block refinements %}
{% endblock %}

<div class="p-2">
    <h4 class="text-muted">Mapping Validation Chart</h4>
    <p class="font-weight-light">The validation bar chart shows the relationship between quality violations and their corresponding quality dimensions. <strong>Hover over the dimensions shown to discover a description.</strong></p>
</div>

<div class="container w-100">
    <div class="row w-100">
            {{ bar_chart_html | safe }}
    </div>
</div>


<script>
 $(document).ready(function () {
  $('body').on('click', '#selectAll', function () {
    if ($(this).hasClass('allChecked')) {
        $('input[type="checkbox"]', '#refinements_table').prop('checked', false);
    } else {
        $('input[type="checkbox"]', '#refinements_table').prop('checked', true);
    }
    $(this).toggleClass('allChecked');
  })
});
</script>

<script>
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})
</script>

<script></script>

<script>
    const tooltips = document.querySelectorAll(".tt")
    tooltips.forEach ( t=> {
       new bootstrap.Tooltip(t)
    })

$('.selectpicker').selectpicker({
  showSubtext:true
});

</script>
</body>

{% endblock %}

</html>
